1 / odds
}
#' Normalize team name to match FanTeam naming
normalize_team_name <- function(team) {
if (is.na(team)) return(NA_character_)
if (team %in% names(TEAM_NAME_MAP)) {
return(unname(TEAM_NAME_MAP[team]))
}
return(team)
}
#' Calculate implied goals from over/under 2.5 odds using Poisson
calculate_implied_total_goals <- function(over_odds, under_odds) {
if (is.na(over_odds) || is.na(under_odds)) return(NA_real_)
over_prob_raw <- odds_to_prob(over_odds)
under_prob_raw <- odds_to_prob(under_odds)
if (is.na(over_prob_raw) || is.na(under_prob_raw)) return(NA_real_)
# Normalize to remove bookmaker margin
total_prob <- over_prob_raw + under_prob_raw
over_prob <- over_prob_raw / total_prob
# Binary search for lambda where P(X > 2) = over_prob
lambda_low <- 0.5
lambda_high <- 6.0
for (i in 1:50) {
lambda_mid <- (lambda_low + lambda_high) / 2
p_over <- 1 - ppois(2, lambda_mid)
if (abs(p_over - over_prob) < 0.001) {
return(lambda_mid)
}
if (p_over < over_prob) {
lambda_low <- lambda_mid
} else {
lambda_high <- lambda_mid
}
}
return((lambda_low + lambda_high) / 2)
}
#' Calculate implied goals for each team from 1X2 odds and total goals
calculate_team_goals <- function(home_odds, draw_odds, away_odds, total_goals) {
if (is.na(total_goals) || is.na(home_odds) || is.na(away_odds)) {
return(list(home_goals = NA_real_, away_goals = NA_real_))
}
home_prob_raw <- odds_to_prob(home_odds)
draw_prob_raw <- odds_to_prob(draw_odds)
away_prob_raw <- odds_to_prob(away_odds)
total_prob <- home_prob_raw + draw_prob_raw + away_prob_raw
home_prob <- home_prob_raw / total_prob
away_prob <- away_prob_raw / total_prob
home_share <- home_prob / (home_prob + away_prob)
home_share_adj <- 0.5 + (home_share - 0.5) * 0.8
home_goals <- total_goals * home_share_adj
away_goals <- total_goals * (1 - home_share_adj)
return(list(home_goals = home_goals, away_goals = away_goals))
}
#' Calculate clean sheet probability from opponent's implied goals
calculate_cs_prob <- function(opponent_goals) {
if (is.na(opponent_goals) || opponent_goals < 0) return(NA_real_)
exp(-opponent_goals)
}
#' Safely extract numeric column, returning NA if missing
safe_col <- function(df, col_name) {
if (col_name %in% names(df)) {
return(suppressWarnings(as.numeric(df[[col_name]])))
}
return(rep(NA_real_, nrow(df)))
}
################################################################################
# DOWNLOAD FUNCTIONS
################################################################################
#' Build URL for a specific season and league
build_url <- function(season_code, league_code) {
sprintf(BASE_URL, season_code, league_code)
}
#' Download data for a single season
#' @param season List with code and display name
#' @param league List with code and name
#' @return Data frame or NULL
download_season_data <- function(season, league) {
url <- build_url(season$code, league$code)
message(sprintf("  Downloading %s %s...", season$display, league$name))
message(sprintf("    URL: %s", url))
tryCatch({
raw_data <- read_csv(url, show_col_types = FALSE)
# Add metadata
raw_data$season <- season$display
raw_data$league <- league$name
message(sprintf("    âœ“ Downloaded %d matches", nrow(raw_data)))
return(raw_data)
}, error = function(e) {
message(sprintf("    âœ— Error: %s", e$message))
return(NULL)
})
}
#' Download all seasons for a league
#' @param league League configuration
#' @param seasons List of season configurations
#' @return Combined data frame
download_all_seasons <- function(league, seasons = SEASONS) {
message(sprintf("\nðŸ“¥ Downloading %s data (%d seasons)...\n",
league$name, length(seasons)))
all_data <- map(seasons, ~download_season_data(.x, league))
# Remove NULLs and combine
all_data <- all_data[!sapply(all_data, is.null)]
if (length(all_data) == 0) {
message("âœ— No data downloaded")
return(NULL)
}
# Combine - handle different column sets across seasons
combined <- bind_rows(all_data)
message(sprintf("\nâœ“ Combined: %d total matches across %d seasons",
nrow(combined), length(all_data)))
return(combined)
}
################################################################################
# PROCESSING FUNCTIONS
################################################################################
#' Process raw data into analysis-ready format
#' @param raw_data Combined raw data from multiple seasons
#' @return Processed data frame
process_odds_data <- function(raw_data) {
if (is.null(raw_data) || nrow(raw_data) == 0) {
return(NULL)
}
message("\nðŸ”§ Processing odds and match stats...\n")
# Check available columns across all data
message("  Available columns: ", paste(head(names(raw_data), 20), collapse = ", "), "...")
# Identify odds columns (may vary by season)
has_b365 <- all(c("B365H", "B365D", "B365A") %in% names(raw_data))
has_pinnacle <- all(c("PSH", "PSD", "PSA") %in% names(raw_data))
# Match stats columns
stat_cols <- c("HS", "AS", "HST", "AST", "HF", "AF", "HC", "AC", "HY", "AY", "HR", "AR")
available_stats <- stat_cols[stat_cols %in% names(raw_data)]
message(sprintf("  Match stats available: %s", paste(available_stats, collapse = ", ")))
# Start processing
processed <- raw_data %>%
# Handle date parsing - try multiple formats
mutate(
match_date = case_when(
!is.na(suppressWarnings(dmy(Date))) ~ dmy(Date),
!is.na(suppressWarnings(ymd(Date))) ~ ymd(Date),
!is.na(suppressWarnings(mdy(Date))) ~ mdy(Date),
TRUE ~ as.Date(NA)
)
) %>%
filter(!is.na(match_date)) %>%
# Normalize team names
mutate(
home_team = sapply(HomeTeam, normalize_team_name),
away_team = sapply(AwayTeam, normalize_team_name)
)
# Add match stats
processed <- processed %>%
mutate(
# Results
home_goals_actual = safe_col(., "FTHG"),
away_goals_actual = safe_col(., "FTAG"),
result = FTR,
# Shots
home_shots = safe_col(., "HS"),
away_shots = safe_col(., "AS"),
home_shots_on_target = safe_col(., "HST"),
away_shots_on_target = safe_col(., "AST"),
# Cards
home_yellow_cards = safe_col(., "HY"),
away_yellow_cards = safe_col(., "AY"),
home_red_cards = safe_col(., "HR"),
away_red_cards = safe_col(., "AR"),
# Corners & Fouls
home_corners = safe_col(., "HC"),
away_corners = safe_col(., "AC"),
home_fouls = safe_col(., "HF"),
away_fouls = safe_col(., "AF")
)
# Add odds - prefer Pinnacle, then Bet365
if (has_pinnacle) {
processed$home_win_odds <- processed$PSH
processed$draw_odds <- processed$PSD
processed$away_win_odds <- processed$PSA
message("  Using Pinnacle odds for 1X2")
} else if (has_b365) {
processed$home_win_odds <- processed$B365H
processed$draw_odds <- processed$B365D
processed$away_win_odds <- processed$B365A
message("  Using Bet365 odds for 1X2")
}
# Add over/under odds
if ("B365>2.5" %in% names(raw_data)) {
processed$over_2_5_odds <- processed$`B365>2.5`
processed$under_2_5_odds <- processed$`B365<2.5`
message("  Using Bet365 Over/Under 2.5 odds")
} else if ("Avg>2.5" %in% names(raw_data)) {
processed$over_2_5_odds <- processed$`Avg>2.5`
processed$under_2_5_odds <- processed$`Avg<2.5`
message("  Using Average Over/Under 2.5 odds")
}
# Calculate derived metrics (vectorized where possible)
message("  Calculating derived metrics...")
processed <- processed %>%
rowwise() %>%
mutate(
# 1X2 probabilities
prob_total = odds_to_prob(home_win_odds) + odds_to_prob(draw_odds) + odds_to_prob(away_win_odds),
home_win_prob = if_else(is.na(prob_total) | prob_total == 0, NA_real_,
odds_to_prob(home_win_odds) / prob_total),
draw_prob = if_else(is.na(prob_total) | prob_total == 0, NA_real_,
odds_to_prob(draw_odds) / prob_total),
away_win_prob = if_else(is.na(prob_total) | prob_total == 0, NA_real_,
odds_to_prob(away_win_odds) / prob_total),
# Implied goals
implied_total_goals = calculate_implied_total_goals(over_2_5_odds, under_2_5_odds),
team_goals_calc = list(calculate_team_goals(home_win_odds, draw_odds, away_win_odds, implied_total_goals)),
home_implied_goals = team_goals_calc$home_goals,
away_implied_goals = team_goals_calc$away_goals,
# Clean sheet probabilities
home_cs_prob = calculate_cs_prob(away_implied_goals),
away_cs_prob = calculate_cs_prob(home_implied_goals),
# Convert to percentages
home_cs_pct = round(home_cs_prob * 100, 1),
away_cs_pct = round(away_cs_prob * 100, 1),
home_win_pct = round(home_win_prob * 100, 1),
away_win_pct = round(away_win_prob * 100, 1),
draw_pct = round(draw_prob * 100, 1)
) %>%
ungroup() %>%
select(-team_goals_calc, -prob_total)
message(sprintf("  âœ“ Processed %d matches", nrow(processed)))
return(processed)
}
#' Create team-centric view (one row per team per match)
#' @param match_data Processed match data
#' @return Data frame with one row per team per match
create_team_view <- function(match_data) {
if (is.null(match_data) || nrow(match_data) == 0) {
return(NULL)
}
message("\nðŸ“Š Creating team-centric view...\n")
# Home team rows
home_rows <- match_data %>%
transmute(
match_date,
season,
league,
team = home_team,
opponent = away_team,
venue = "Home",
# === PRE-MATCH ODDS (for model inputs) ===
implied_goals_for = round(home_implied_goals, 2),
implied_goals_against = round(away_implied_goals, 2),
implied_total_goals = round(implied_total_goals, 2),
clean_sheet_pct = home_cs_pct,
win_pct = home_win_pct,
draw_pct,
# Raw odds
win_odds = home_win_odds,
draw_odds,
lose_odds = away_win_odds,
over_2_5_odds,
under_2_5_odds,
# === ACTUAL RESULTS (for model outputs) ===
goals_scored = home_goals_actual,
goals_conceded = away_goals_actual,
result_actual = case_when(
result == "H" ~ "Win",
result == "D" ~ "Draw",
result == "A" ~ "Loss",
TRUE ~ NA_character_
),
clean_sheet_actual = (away_goals_actual == 0),
# === MATCH STATS (for fantasy modeling) ===
shots = home_shots,
shots_on_target = home_shots_on_target,
yellow_cards = home_yellow_cards,
red_cards = home_red_cards,
corners = home_corners,
fouls_committed = home_fouls,
# Opponent/defensive stats
shots_faced = away_shots,
shots_on_target_faced = away_shots_on_target,
opp_yellow_cards = away_yellow_cards,
opp_red_cards = away_red_cards,
opp_corners = away_corners,
fouls_won = away_fouls
)
# Away team rows
away_rows <- match_data %>%
transmute(
match_date,
season,
league,
team = away_team,
opponent = home_team,
venue = "Away",
# PRE-MATCH ODDS
implied_goals_for = round(away_implied_goals, 2),
implied_goals_against = round(home_implied_goals, 2),
implied_total_goals = round(implied_total_goals, 2),
clean_sheet_pct = away_cs_pct,
win_pct = away_win_pct,
draw_pct,
# Raw odds (from away perspective)
win_odds = away_win_odds,
draw_odds,
lose_odds = home_win_odds,
over_2_5_odds,
under_2_5_odds,
# ACTUAL RESULTS
goals_scored = away_goals_actual,
goals_conceded = home_goals_actual,
result_actual = case_when(
result == "A" ~ "Win",
result == "D" ~ "Draw",
result == "H" ~ "Loss",
TRUE ~ NA_character_
),
clean_sheet_actual = (home_goals_actual == 0),
# MATCH STATS
shots = away_shots,
shots_on_target = away_shots_on_target,
yellow_cards = away_yellow_cards,
red_cards = away_red_cards,
corners = away_corners,
fouls_committed = away_fouls,
# Opponent stats
shots_faced = home_shots,
shots_on_target_faced = home_shots_on_target,
opp_yellow_cards = home_yellow_cards,
opp_red_cards = home_red_cards,
opp_corners = home_corners,
fouls_won = home_fouls
)
# Combine
team_view <- bind_rows(home_rows, away_rows) %>%
arrange(desc(match_date), team)
# Add scrape timestamp
team_view$scrape_date <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
message(sprintf("  âœ“ Created %d team-match rows", nrow(team_view)))
message(sprintf("    Seasons: %s", paste(unique(team_view$season), collapse = ", ")))
message(sprintf("    Date range: %s to %s", min(team_view$match_date), max(team_view$match_date)))
return(team_view)
}
################################################################################
# GOOGLE SHEETS FUNCTIONS
################################################################################
#' Write data to Google Sheet (full replace for multi-season)
write_to_sheet <- function(data, sheet_id, sheet_name) {
if (is.null(data) || nrow(data) == 0) {
message("  No data to write")
return(FALSE)
}
message(sprintf("\nðŸ“¤ Writing to Google Sheet: %s", sheet_name))
message(sprintf("   Rows: %d", nrow(data)))
tryCatch({
sheet_info <- gs4_get(sheet_id)
existing_sheets <- sheet_info$sheets$name
if (sheet_name %in% existing_sheets) {
message("  Clearing existing data...")
range_clear(ss = sheet_id, sheet = sheet_name)
Sys.sleep(1)
}
message("  Writing data...")
# For large datasets, write in chunks
if (nrow(data) > 5000) {
# Write header + first chunk
chunk_size <- 2500
n_chunks <- ceiling(nrow(data) / chunk_size)
for (i in 1:n_chunks) {
start_row <- (i - 1) * chunk_size + 1
end_row <- min(i * chunk_size, nrow(data))
chunk <- data[start_row:end_row, ]
if (i == 1) {
sheet_write(chunk, ss = sheet_id, sheet = sheet_name)
} else {
sheet_append(chunk, ss = sheet_id, sheet = sheet_name)
}
message(sprintf("    Chunk %d/%d written (rows %d-%d)", i, n_chunks, start_row, end_row))
Sys.sleep(0.5)  # Rate limiting
}
} else {
sheet_write(data, ss = sheet_id, sheet = sheet_name)
}
message("  âœ“ Write successful")
return(TRUE)
}, error = function(e) {
message(sprintf("  âœ— Error: %s", e$message))
return(FALSE)
})
}
################################################################################
# ANALYSIS HELPERS
################################################################################
#' Print summary statistics for the dataset
print_data_summary <- function(team_view) {
message("\n================================================================================")
message("                         DATA SUMMARY")
message("================================================================================\n")
message(sprintf("Total observations: %d team-matches", nrow(team_view)))
message(sprintf("Unique teams: %d", length(unique(team_view$team))))
message(sprintf("Seasons: %s", paste(sort(unique(team_view$season)), collapse = ", ")))
message(sprintf("Date range: %s to %s", min(team_view$match_date), max(team_view$match_date)))
message("\n--- Observations by Season ---")
season_counts <- team_view %>%
group_by(season) %>%
summarise(n = n(), matches = n()/2, .groups = "drop") %>%
arrange(desc(season))
print(as.data.frame(season_counts))
message("\n--- Stats Coverage ---")
stats_cols <- c("shots", "shots_on_target", "yellow_cards", "red_cards",
"corners", "fouls_committed", "implied_goals_for")
coverage <- sapply(stats_cols, function(col) {
if (col %in% names(team_view)) {
round(sum(!is.na(team_view[[col]])) / nrow(team_view) * 100, 1)
} else {
0
}
})
coverage_df <- data.frame(
stat = names(coverage),
pct_available = coverage
)
print(coverage_df)
message("\n--- Key Averages (for model validation) ---")
avgs <- team_view %>%
filter(!is.na(shots)) %>%
summarise(
avg_goals = round(mean(goals_scored, na.rm = TRUE), 2),
avg_shots = round(mean(shots, na.rm = TRUE), 1),
avg_sot = round(mean(shots_on_target, na.rm = TRUE), 1),
avg_yellows = round(mean(yellow_cards, na.rm = TRUE), 2),
avg_reds = round(mean(red_cards, na.rm = TRUE), 3),
avg_corners = round(mean(corners, na.rm = TRUE), 1),
avg_implied_goals = round(mean(implied_goals_for, na.rm = TRUE), 2)
)
print(as.data.frame(avgs))
message("\n--- Home vs Away Split ---")
venue_split <- team_view %>%
filter(!is.na(shots)) %>%
group_by(venue) %>%
summarise(
n = n(),
avg_goals = round(mean(goals_scored, na.rm = TRUE), 2),
avg_shots = round(mean(shots, na.rm = TRUE), 1),
avg_sot = round(mean(shots_on_target, na.rm = TRUE), 1),
win_rate = round(mean(result_actual == "Win", na.rm = TRUE) * 100, 1),
.groups = "drop"
)
print(as.data.frame(venue_split))
message("\n================================================================================\n")
}
################################################################################
# MAIN EXECUTION
################################################################################
main <- function() {
message("================================================================================")
message("     FOOTBALL ODDS & MATCH STATS SCRAPER - MULTI-SEASON (v3.0)")
message("================================================================================")
message("")
message(sprintf("ðŸ“Š Scraping %d seasons of Premier League data", length(SEASONS)))
message(sprintf("   Seasons: %s", paste(sapply(SEASONS, function(x) x$display), collapse = ", ")))
message("")
message("ðŸ“ Output:")
message(sprintf("   Google Sheet: https://docs.google.com/spreadsheets/d/%s/edit", GOOGLE_SHEET_ID))
message(sprintf("   Worksheet: %s", ODDS_SHEET_NAME))
message("")
message("ðŸŽ¯ Purpose: Build regression models for fantasy impact analysis")
message("   - Predict goals, shots, SoT, cards from pre-match odds")
message("   - Enable scenario modeling: 'What if implied goals = X?'")
message("================================================================================")
# Authenticate
message("\nðŸ” Authenticating with Google Sheets...")
tryCatch({
gs4_auth()
message("âœ“ Authentication successful")
}, error = function(e) {
stop("Failed to authenticate: ", e$message)
})
# Download all seasons
raw_data <- download_all_seasons(LEAGUES$premier_league, SEASONS)
if (is.null(raw_data)) {
message("\nâœ— Failed to download data. Exiting.")
return(NULL)
}
# Process
processed <- process_odds_data(raw_data)
if (is.null(processed)) {
message("\nâœ— Failed to process data. Exiting.")
return(NULL)
}
# Create team view
team_view <- create_team_view(processed)
# Print summary
print_data_summary(team_view)
# Write to Google Sheets
write_to_sheet(team_view, GOOGLE_SHEET_ID, ODDS_SHEET_NAME)
message("\n================================================================================")
message("                              COMPLETE")
message("================================================================================")
message(sprintf("âœ“ %d team-match observations written", nrow(team_view)))
message(sprintf("âœ“ Data ready for regression modeling"))
message("")
message("Next steps:")
message("  1. Run fanteam_regression_analysis.R to build models")
message("  2. Use models to translate odds adjustments -> fantasy impact")
message("================================================================================\n")
return(list(
raw = raw_data,
processed = processed,
team_view = team_view
))
}
################################################################################
# RUN
################################################################################
result <- main()
