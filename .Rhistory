message(sprintf("  ðŸ“¤ Writing %d %s to %s...", nrow(data), data_type, sheet_name))
tryCatch({
sheet_info <- gs4_get(sheet_id)
existing_sheets <- sheet_info$sheets$name
if (!sheet_name %in% existing_sheets) {
sheet_write(data, ss = sheet_id, sheet = sheet_name)
} else {
# Match existing column order
existing_data <- tryCatch({
read_sheet(sheet_id, sheet = sheet_name, n_max = 1)
}, error = function(e) NULL)
if (!is.null(existing_data) && ncol(existing_data) > 0) {
existing_cols <- names(existing_data)
for (col in existing_cols) {
if (!col %in% names(data)) data[[col]] <- NA
}
new_cols <- setdiff(names(data), existing_cols)
data <- data %>% select(all_of(c(existing_cols, new_cols)))
}
sheet_append(data, ss = sheet_id, sheet = sheet_name)
}
message(sprintf("    âœ“ Write successful (%d rows)", nrow(data)))
return(TRUE)
}, error = function(e) {
message(sprintf("    âœ— Error: %s", e$message))
return(FALSE)
})
}
get_league_url <- function(league, season) {
league_code <- LEAGUE_CODES[league]
sprintf("https://fbref.com/en/comps/%s/%s/%s-Stats", league_code, season, league)
}
polite_delay <- function() {
Sys.sleep(RATE_LIMIT_DELAY)
}
scrape_league_match_urls <- function(league, season, browser) {
message(sprintf("\n=== Getting Match URLs for %s %s ===", league, season))
league_url <- get_league_url(league, season)
polite_delay()
tryCatch({
page <- fetch_page(league_url, browser)
if (is.null(page)) return(NULL)
schedule_link <- page %>%
html_nodes("a") %>%
keep(~ grepl("Scores & Fixtures|Schedule", html_text(.))) %>%
html_attr("href") %>%
first()
if (is.na(schedule_link)) {
schedule_link <- page %>%
html_nodes("div.filter a") %>%
keep(~ grepl("Scores|Schedule|Fixtures", html_attr(., "href"))) %>%
html_attr("href") %>%
first()
}
if (is.na(schedule_link)) stop("Could not find schedule link")
if (!grepl("^http", schedule_link)) {
schedule_url <- paste0("https://fbref.com", schedule_link)
} else {
schedule_url <- schedule_link
}
polite_delay()
schedule_page <- fetch_page(schedule_url, browser)
if (is.null(schedule_page)) return(NULL)
fixtures_table <- schedule_page %>% html_node("table.stats_table")
if (is.null(fixtures_table)) stop("Could not find fixtures table")
rows <- fixtures_table %>% html_nodes("tbody tr")
match_data <- map_df(rows, function(row) {
if (length(html_attrs(row)) > 0) {
if ("class" %in% names(html_attrs(row))) {
if (grepl("spacer", html_attr(row, "class"))) return(NULL)
}
}
match_link <- row %>% html_node("td[data-stat='score'] a") %>% html_attr("href")
if (is.na(match_link)) return(NULL)
score_text <- row %>% html_node("td[data-stat='score'] a") %>% html_text(trim = TRUE)
home_goals <- NA; away_goals <- NA
if (!is.na(score_text) && score_text != "") {
score_parts <- str_split(score_text, "[â€“\\-â€”]")[[1]]
if (length(score_parts) == 2) {
home_goals <- as.integer(str_trim(score_parts[1]))
away_goals <- as.integer(str_trim(score_parts[2]))
}
}
gameweek <- row %>% html_node("th[data-stat='gameweek']") %>% html_text(trim = TRUE)
date <- row %>% html_node("td[data-stat='date']") %>% html_text(trim = TRUE)
home_team <- row %>% html_node("td[data-stat='home_team']") %>% html_text(trim = TRUE)
away_team <- row %>% html_node("td[data-stat='away_team']") %>% html_text(trim = TRUE)
venue <- row %>% html_node("td[data-stat='venue']") %>% html_text(trim = TRUE)
match_url <- if (!grepl("^http", match_link)) {
paste0("https://fbref.com", match_link)
} else match_link
tibble(gameweek = gameweek, date = date, home_team = home_team, away_team = away_team,
home_goals = home_goals, away_goals = away_goals, venue = venue, match_url = match_url)
})
match_data <- match_data %>% filter(!is.na(match_url))
message(sprintf("âœ“ Found %d completed matches", nrow(match_data)))
return(match_data)
}, error = function(e) {
message(sprintf("ERROR: %s", e$message))
return(NULL)
})
}
scrape_match_all_data <- function(match_url, match_info, league, browser, existing_urls) {
polite_delay()
need_player <- !(match_url %in% existing_urls$player)
need_shots <- !(match_url %in% existing_urls$shots)
data_needed <- c(
if (need_player) "Player Stats" else NULL,
if (need_shots) "Shots" else NULL
)
if (length(data_needed) == 0) {
message("    â­ï¸ All data exists - skipping")
return(list(player_stats = NULL, shots = NULL, success = TRUE))
}
message(sprintf("  Collecting: %s", paste(data_needed, collapse = ", ")))
page <- tryCatch({ fetch_page(match_url, browser) }, error = function(e) NULL)
if (is.null(page)) {
return(list(player_stats = NULL, shots = NULL, success = FALSE))
}
tryCatch({
# Get match metadata
match_date <- page %>%
html_nodes("div.scorebox_meta div") %>%
html_text() %>%
.[1] %>%
str_trim()
teams <- page %>%
html_nodes("div.scorebox div:nth-child(1) strong a") %>%
html_text() %>%
.[1:2]
if (length(teams) < 2) {
message("    Could not extract team names")
return(list(player_stats = NULL, shots = NULL, success = FALSE))
}
home_team <- teams[1]
away_team <- teams[2]
results <- list(player_stats = NULL, shots = NULL, success = TRUE)
if (need_player) {
# Extract and combine Summary + Possession
results$player_stats <- extract_combined_player_stats(
page, home_team, away_team, match_date, match_url, match_info, league
)
}
if (need_shots) {
results$shots <- extract_shots(page, home_team, away_team, match_date, match_url, match_info, league)
}
counts <- c()
if (!is.null(results$player_stats)) counts <- c(counts, sprintf("Players: %d", nrow(results$player_stats)))
if (!is.null(results$shots)) counts <- c(counts, sprintf("Shots: %d", nrow(results$shots)))
if (length(counts) > 0) message(sprintf("    âœ“ %s", paste(counts, collapse = ", ")))
return(results)
}, error = function(e) {
message(sprintf("    âœ— Parse error: %s", e$message))
return(list(player_stats = NULL, shots = NULL, success = FALSE))
})
}
extract_combined_player_stats <- function(page, home_team, away_team, match_date, match_url, match_info, league) {
stats_tables <- page %>% html_nodes("table.stats_table")
# Find Summary tables
summary_home <- NULL; summary_away <- NULL
for (tbl in stats_tables) {
table_id <- html_attr(tbl, "id")
if (!is.na(table_id) && grepl("stats_.*_summary", table_id)) {
if (is.null(summary_home)) summary_home <- tbl
else if (is.null(summary_away)) { summary_away <- tbl; break }
}
}
# Find Possession tables
poss_home <- NULL; poss_away <- NULL
for (tbl in stats_tables) {
table_id <- html_attr(tbl, "id")
if (!is.na(table_id) && grepl("stats_.*_possession", table_id)) {
if (is.null(poss_home)) poss_home <- tbl
else if (is.null(poss_away)) { poss_away <- tbl; break }
}
}
# Parse tables
parse_player_table <- function(table, team_name) {
if (is.null(table)) return(NULL)
headers <- table %>%
html_nodes("thead tr:last-child th") %>%
html_attr("data-stat")
headers[is.na(headers)] <- "player"
rows <- table %>% html_nodes("tbody tr:not(.thead)")
data_list <- lapply(rows, function(row) {
cells <- row %>% html_nodes("th, td")
values <- cells %>% html_text(trim = TRUE)
if (length(values) == 0) return(NULL)
player_link <- row %>% html_node("th a") %>% html_attr("href")
n <- min(length(values), length(headers))
values <- values[1:n]
names(values) <- headers[1:n]
df <- as.data.frame(t(values), stringsAsFactors = FALSE)
df$player_href <- player_link
return(df)
})
data_list <- data_list[!sapply(data_list, is.null)]
if (length(data_list) > 0) {
df <- bind_rows(data_list)
df$team <- team_name
return(df)
}
return(NULL)
}
# Parse Summary
summary_home_df <- parse_player_table(summary_home, home_team)
summary_away_df <- parse_player_table(summary_away, away_team)
summary_df <- bind_rows(summary_home_df, summary_away_df)
# Parse Possession
poss_home_df <- parse_player_table(poss_home, home_team)
poss_away_df <- parse_player_table(poss_away, away_team)
poss_df <- bind_rows(poss_home_df, poss_away_df)
# Combine Summary + Possession
if (!is.null(summary_df) && nrow(summary_df) > 0) {
summary_df$join_key <- paste(summary_df$player, summary_df$team, sep = "|||")
if (!is.null(poss_df) && nrow(poss_df) > 0) {
poss_df$join_key <- paste(poss_df$player, poss_df$team, sep = "|||")
# Get possession columns not in summary
summary_cols <- names(summary_df)
poss_only_cols <- setdiff(names(poss_df), summary_cols)
poss_only_cols <- c("join_key", poss_only_cols)
poss_slim <- poss_df %>%
select(any_of(poss_only_cols)) %>%
distinct(join_key, .keep_all = TRUE)
combined_df <- summary_df %>%
left_join(poss_slim, by = "join_key", suffix = c("", "_poss"))
} else {
combined_df <- summary_df
}
combined_df <- combined_df %>% select(-join_key)
# Add metadata
combined_df$league <- league
combined_df$season <- SEASON
combined_df$match_date <- match_date
combined_df$home_team <- home_team
combined_df$away_team <- away_team
combined_df$match_url <- match_url
combined_df$gameweek <- match_info$gameweek
combined_df$venue <- match_info$venue
return(combined_df)
}
return(NULL)
}
extract_shots <- function(page, home_team, away_team, match_date, match_url, match_info, league) {
shots_table <- page %>% html_node("table#shots_all")
if (is.null(shots_table)) return(NULL)
headers <- shots_table %>%
html_nodes("thead tr:last-child th") %>%
html_attr("data-stat")
headers[is.na(headers)] <- "minute"
rows <- shots_table %>% html_nodes("tbody tr:not(.thead)")
shots_list <- lapply(rows, function(row) {
cells <- row %>% html_nodes("th, td")
values <- cells %>% html_text(trim = TRUE)
if (length(values) == 0) return(NULL)
n <- min(length(values), length(headers))
values <- values[1:n]
names(values) <- headers[1:n]
as.data.frame(t(values), stringsAsFactors = FALSE)
})
shots_list <- shots_list[!sapply(shots_list, is.null)]
if (length(shots_list) == 0) return(NULL)
shots_df <- bind_rows(shots_list)
shots_df$league <- league
shots_df$season <- SEASON
shots_df$match_date <- match_date
shots_df$home_team <- home_team
shots_df$away_team <- away_team
shots_df$match_url <- match_url
shots_df$gameweek <- match_info$gameweek
return(shots_df)
}
flush_batch_to_sheets <- function(batch_data, league) {
message("\n  === FLUSHING BATCH ===")
# Write Combined Player Stats
if (!is.null(batch_data$player_stats) && nrow(batch_data$player_stats) > 0) {
write_to_google_sheet(
batch_data$player_stats,
SHEETS_CONFIG$player_match_stats$sheet_id,
SHEETS_CONFIG$player_match_stats$sheet_name,
SCHEMA_PLAYER_MATCH_STATS,
"player stats"
)
save_local_backup(batch_data$player_stats, "player_stats", league)
}
# Write Shots
if (!is.null(batch_data$shots) && nrow(batch_data$shots) > 0) {
write_to_google_sheet(
batch_data$shots,
SHEETS_CONFIG$shots$sheet_id,
SHEETS_CONFIG$shots$sheet_name,
SCHEMA_SHOTS,
"shots"
)
save_local_backup(batch_data$shots, "shots", league)
}
message("  === BATCH COMPLETE ===\n")
}
process_league <- function(league, season, browser, url_cache) {
message("\n################################################################################")
message(sprintf("# Processing: %s %s", league, season))
message("################################################################################")
existing_urls <- get_existing_urls_for_league(league, url_cache)
message(sprintf("  Existing - Player: %d, Shots: %d, Goals: %d",
length(existing_urls$player), length(existing_urls$shots),
length(existing_urls$team_goals)))
all_matches <- scrape_league_match_urls(league, season, browser)
if (is.null(all_matches) || nrow(all_matches) == 0) {
message("âœ— No matches found")
return(list(matches_processed = 0, matches_failed = 0))
}
# Team Goals (from fixture list)
new_team_goals <- all_matches %>%
filter(!match_url %in% existing_urls$team_goals) %>%
filter(!is.na(home_goals) & !is.na(away_goals))
if (nrow(new_team_goals) > 0) {
team_goals_df <- new_team_goals %>%
mutate(league = league, season = season) %>%
select(league, season, gameweek, date, home_team, away_team,
home_goals, away_goals, venue, match_url)
write_to_google_sheet(
team_goals_df,
SHEETS_CONFIG$team_goals$sheet_id,
SHEETS_CONFIG$team_goals$sheet_name,
SCHEMA_TEAM_GOALS,
"team goals"
)
message(sprintf("âœ“ Wrote %d team goal records", nrow(team_goals_df)))
}
# Filter matches needing page visits
new_matches <- all_matches %>%
filter(!match_url %in% existing_urls$complete)
if (nrow(new_matches) == 0) {
message("âœ“ All matches up to date!")
return(list(matches_processed = 0, matches_failed = 0,
player_count = 0, shots_count = 0,
team_goals_count = nrow(new_team_goals)))
}
message(sprintf("\n=== MATCHES TO PROCESS: %d ===", nrow(new_matches)))
message(sprintf("Estimated time: ~%.1f minutes", (nrow(new_matches) * RATE_LIMIT_DELAY) / 60))
# Process in batches
batch_player <- list()
batch_shots <- list()
total_processed <- 0
total_failed <- 0
total_player <- 0
total_shots <- 0
batch_count <- 0
for (i in 1:nrow(new_matches)) {
match <- new_matches[i, ]
message(sprintf("\n[%d/%d] %s vs %s", i, nrow(new_matches), match$home_team, match$away_team))
data <- scrape_match_all_data(match$match_url, match, league, browser, existing_urls)
if (isTRUE(data$success)) {
if (!is.null(data$player_stats) && nrow(data$player_stats) > 0) {
batch_player[[length(batch_player) + 1]] <- data$player_stats
}
if (!is.null(data$shots) && nrow(data$shots) > 0) {
batch_shots[[length(batch_shots) + 1]] <- data$shots
}
total_processed <- total_processed + 1
batch_count <- batch_count + 1
} else {
total_failed <- total_failed + 1
}
# Flush batch
if (batch_count >= BATCH_SIZE || i == nrow(new_matches)) {
batch_data <- list(
player_stats = if (length(batch_player) > 0) bind_rows(batch_player) else data.frame(),
shots = if (length(batch_shots) > 0) bind_rows(batch_shots) else data.frame()
)
if (nrow(batch_data$player_stats) > 0 || nrow(batch_data$shots) > 0) {
flush_batch_to_sheets(batch_data, league)
total_player <- total_player + nrow(batch_data$player_stats)
total_shots <- total_shots + nrow(batch_data$shots)
}
batch_player <- list()
batch_shots <- list()
batch_count <- 0
message(sprintf("  ðŸ“Š Progress: %d/%d matches", i, nrow(new_matches)))
}
}
message(sprintf("\nâœ“ %s COMPLETE: %d processed, %d failed", league, total_processed, total_failed))
return(list(
matches_processed = total_processed,
matches_failed = total_failed,
player_count = total_player,
shots_count = total_shots,
team_goals_count = nrow(new_team_goals)
))
}
main <- function() {
message("================================================================================")
message("       FBref COMBINED SCRAPER - UNIFIED PLAYER MATCH STATS")
message("================================================================================")
message(sprintf("Leagues: %s", paste(LEAGUES_TO_SCRAPE, collapse = ", ")))
message(sprintf("Season: %s", SEASON))
message("")
message("ðŸ“Š OUTPUT SHEETS:")
message("   â€¢ Player_Match_Stats: Combined Summary + Possession (NEW!)")
message("   â€¢ Shot_Data: Individual shots")
message("   â€¢ Team_Goals: Match scores")
message("")
message(sprintf("âš™ï¸ Settings: Batch %d, Rate limit %ds", BATCH_SIZE, RATE_LIMIT_DELAY))
message("================================================================================")
init_backup_dir()
url_cache <- load_all_existing_urls()
browser <- init_browser()
message("\nAuthenticating with Google Sheets...")
tryCatch({
gs4_auth()
message("âœ“ Authenticated")
}, error = function(e) {
close_browser(browser)
stop("Auth failed: ", e$message)
})
all_results <- list()
tryCatch({
for (league in LEAGUES_TO_SCRAPE) {
result <- tryCatch({
process_league(league, SEASON, browser, url_cache)
}, error = function(e) {
message(sprintf("ERROR for %s: %s", league, e$message))
NULL
})
if (!is.null(result)) all_results[[league]] <- result
if (league != LEAGUES_TO_SCRAPE[length(LEAGUES_TO_SCRAPE)]) {
message(sprintf("\nâ¸ Pausing %ds...", LEAGUE_DELAY))
Sys.sleep(LEAGUE_DELAY)
}
}
}, finally = {
close_browser(browser)
})
# Summary
message("\n================================================================================")
message("                              SUMMARY")
message("================================================================================")
for (league in names(all_results)) {
r <- all_results[[league]]
message(sprintf("âœ“ %s: %d matches, %d players, %d shots, %d goals",
league, r$matches_processed, r$player_count, r$shots_count, r$team_goals_count))
}
message("")
message("Sheets:")
message(sprintf("  Player Stats: https://docs.google.com/spreadsheets/d/%s/edit",
SHEETS_CONFIG$player_match_stats$sheet_id))
message(sprintf("  Shots: https://docs.google.com/spreadsheets/d/%s/edit",
SHEETS_CONFIG$shots$sheet_id))
message(sprintf("  Team Goals: https://docs.google.com/spreadsheets/d/%s/edit",
SHEETS_CONFIG$team_goals$sheet_id))
message("================================================================================\n")
return(all_results)
}
result <- main()
source("fbref_soccer_scrapers/fb_combined_scraper.R")
rlibrary(googlesheets4)
rlibrary(googlesheets4)
library(googlesheets4)
gs4_auth()
library(googlesheets4)
gs4_auth()
library(googlesheets4)
# Check existing Google Sheet columns
existing <- read_sheet("1oxQ6rk_B_r2QUNZxGssmDEopKqJD0otMt_r1hPOufT0", sheet = "Shot_Data", n_max = 1)
cat("Google Sheet columns:\n")
print(names(existing))
# Check your latest backup
backup <- read.csv("fbref_backups/shots_Premier-League_20251223_190515.csv")
cat("\nBackup file columns:\n")
print(names(backup))
source("fbref_soccer_scrapers/fbref_combined_scraper.R")
source("fbref_soccer_scrapers/fb_combined_scraper.R")
library(googlesheets4)
gs4_auth()
library(googlesheets4)
gs4_auth()
library(googlesheets4)
# Check existing Google Sheet columns
existing <- read_sheet("12MXPMsuI4S7EiTPnVpaqx5-riXoK37cEtPo-MFOf1fA", sheet = "Player_Match_Stats", n_max = 1)
cat("Google Sheet columns:\n")
print(names(existing))
# Check your latest backup
backup <- read.csv("fbref_backups/player_stats_Championship_20251223_220332.csv")
cat("\nBackup file columns:\n")
print(names(backup))
shiny::runApp()
old_backup <- read.csv("fbref_backups/player_stats_Premier_League_20251215_xxxxxx.csv")  # adjust filename
old_backup <- read.csv("fbref_backups/player_stats_Premier_League_20251215_xxxxxx.csv")  # adjust filename
"fouls" %in% names(old_backup)
# List all player_stats backups, sorted oldest first
files <- list.files("fbref_backups", pattern = "^player_stats_.*\\.csv$", full.names = TRUE)
files <- files[order(file.info(files)$mtime)]
# Check the oldest one
cat("Oldest backup:", files[1], "\n")
oldest <- read.csv(files[1])
cat("\nHas 'fouls' column:", "fouls" %in% names(oldest), "\n")
runApp()
source("fbref_soccer_scrapers/fb_combined_scraper.R")
source("soccer_cache.R")  # or soccer_data_loader.R
source("R/soccer/soccer_cache.R")
clear_soccer_cache()
runApp()
runApp()
clear_soccer_cache()
runApp()
clear_soccer_cache()
runApp()
runApp()
runApp()
clear_soccer_cache()
runApp()
runApp()
